<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="999 Simulator" />
  <title>999 Emergency Call Simulator</title>
  <style>
    :root {
      --bg1:#0b1220;
      --bg2:#071023;
      --card:#0a1020;
      --stroke:#233252;
      --muted:#aab7d6;
      --white:#e8eefc;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --fitScale: 1;
    }
    body {
      margin:0;
      min-height:100vh;
      background: radial-gradient(1200px 600px at 20% 10%, #2b78ff33, transparent 55%),
                  radial-gradient(900px 600px at 80% 40%, #00ffd533, transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--white);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      overflow: hidden;

    }
.app{
  width: min(1100px, 98vw);
  display:grid;
  grid-template-columns: 380px 1fr;
  gap:24px;
  align-items:start;
}

/* NEW: scaling wrapper (do NOT scale .app itself) */
.app-wrap{
  transform: scale(var(--fitScale));
  transform-origin: top center;
  will-change: transform;
}


    .header {
      grid-column:1 / -1;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:16px 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .header h1 { margin:0; font-size:26px; letter-spacing:.5px; }
    .header .sub { font-size:12px; color: var(--muted); margin-top:4px; }
    .pill {
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .phone {
      background:#0a0f1c;
      border:2px solid var(--stroke);
      border-radius:34px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .topbar {
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between;
      background:#070b15;
      border-bottom:1px solid #1e2a44;
      font-size:12px;
      opacity:.95;
    }
    .screen {
      padding:14px;
      background: linear-gradient(180deg, #0b1220, #070b15);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .digitsWrap {
      border:1px solid var(--stroke);
      background: var(--card);
      border-radius:18px;
      padding:14px;
    }
    .digits {
      font-size:34px;
      letter-spacing:10px;
      text-align:center;
      min-height:46px;
    }
    .callRow {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:6px;
      font-size:12px;
      color: var(--muted);
    }
    .timer {
      font-variant-numeric: tabular-nums;
      font-weight:800;
      color:#ffd37d;
      letter-spacing:.5px;
    }
    .pad {
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .key {
      background:#121a2b;
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px 10px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      transition: transform .03s ease;
    }
    .key:active { transform: scale(.98); }
    .key .n { font-size:26px; font-weight:900; }
    .key .l { font-size:11px; opacity:.7; margin-top:2px; }
    .row { display:flex; gap:10px; }
    .btn {
      flex:1;
      border:none;
      border-radius:18px;
      padding:14px 12px;
      font-weight:900;
      cursor:pointer;
      transition: transform .03s ease, opacity .2s ease;
    }
    .btn:active { transform: scale(.99); }
    .btn:disabled { opacity:.45; cursor:not-allowed; }
    .callBtn { background:#27d67a; color:#05110b; }
    .endBtn { background:#ff3b3b; color:white; }
    .wave {
      height:22px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(90deg, rgba(39,214,122,.35), rgba(39,214,122,.08));
      overflow:hidden;
      position:relative;
    }
    .wave::before {
      content:"";
      position:absolute;
      inset:0;
      background: repeating-linear-gradient(90deg, rgba(255,255,255,.55) 0 2px, transparent 2px 6px);
      opacity:.25;
      animation: wave 1.2s linear infinite;
    }
    @keyframes wave { from { transform: translateX(0px); } to { transform: translateX(-60px); } }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12);
      border-radius:22px;
      box-shadow: 0 14px 44px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .cardHead {
      padding:14px 18px;
      background: linear-gradient(180deg, #d73a3a, #b82525);
      border-bottom:1px solid rgba(0,0,0,.15);
      font-weight:900;
      letter-spacing:1px;
      text-transform:uppercase;
      font-size:18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .badge {
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.25);
      text-transform:none;
      letter-spacing:.2px;
      font-weight:800;
      white-space:nowrap;
    }
    .cardBody {
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.01));
    }
    .hero {
      display:flex;
      align-items:center;
      gap:16px;
      padding:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:18px;
      margin-bottom:14px;
    }
    .iconWrap {
      width:74px; height:74px;
      border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .hero h2 { margin:0; font-size:28px; letter-spacing:.4px; }
    .hero .small { margin-top:6px; color: var(--muted); font-size:13px; }
    .desc {
      margin: 14px 0 0;
      font-size:18px;
      line-height:1.35;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:16px;
    }
    .cardActions {
      display:flex;
      gap:12px;
      margin-top:16px;
      flex-wrap:wrap;
    }
    .action {
      flex:1;
      min-width: 210px;
      border:none;
      border-radius:18px;
      padding:14px 16px;
      font-weight:900;
      cursor:pointer;
    }
    .read { background:#1e5eff; color:white; }
    .next { background:#f6c945; color:#1a1403; }
    .action:active { transform: scale(.99); }
    .note { margin-top:10px; font-size:12px; color: var(--muted); }

    @media (max-width: 900px) { .app { grid-template-columns: 1fr; } }
  
/* ===========================
   iPad + Classroom Optimisation
   =========================== */
body{
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  -webkit-text-size-adjust: 100%;
}
*{ -webkit-tap-highlight-color: transparent; }
button, .key{ touch-action: manipulation; }

/* Background: uses optional bg-lights.png if present */
body{
  background:
    url("bg-lights.png") center top / cover no-repeat,
    radial-gradient(900px 520px at 25% 25%, rgba(140, 190, 255, 0.25), transparent 65%),
    linear-gradient(180deg, #2b5fb8 0%, #5fa0e6 50%, #e6f2ff 100%);
}

/* Layout on iPad */
@media (max-width: 1024px){
  .app{
    width: min(980px, 96vw);
    grid-template-columns: 1fr;
    gap: 18px;
  }
  .phone{
    max-width: 520px;
    margin: 0 auto;
  }
}

/* Modern phone */
.phone{
  border-radius: 38px;
  border: 1px solid rgba(255,255,255,0.18);
  background: linear-gradient(180deg, rgba(16,20,32,0.95), rgba(8,10,18,0.96));
  box-shadow: 0 30px 80px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.10);
}
.topbar{
  background: rgba(0,0,0,0.35);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.screen{
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.20));
}
.key{
  padding: 18px 10px;
  border-radius: 22px;
}
.key .n{ font-size: 30px; }
.btn, .action{
  padding: 16px 16px;
  font-size: 16px;
  border-radius: 22px;
}

/* Scenario card: readable + eye-catching (no patterns/lines) */
#scenarioCard{
  background: rgba(255,255,255,0.92);
  border-radius: 28px;
  border: 1px solid rgba(255,255,255,0.35);
  box-shadow: 0 26px 70px rgba(0,0,0,0.28);
}
#scenarioCard::before{ display:none; }
#scenarioCard .cardBody{ background: transparent; }
#scenarioCard h2,
#scenarioCard .small,
#scenarioCard .desc,
#scenarioCard .note{ color: #0b1220; }

.ribbonRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
}
.ribbon, .idPill{
  font-weight:900;
  font-size:12px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(11,18,32,0.18);
  background: rgba(11,18,32,0.08);
  color:#0b1220;
  white-space:nowrap;
  text-transform:uppercase;
  letter-spacing:.8px;
}
#scenarioTitle{
  font-weight: 900;
  font-size: 34px;
  letter-spacing: .2px;
}
#scenarioMeta{
  color: rgba(11,18,32,0.65);
  font-weight: 700;
}
.desc{
  background: rgba(11,18,32,0.08);
  border: 1px solid rgba(11,18,32,0.10);
  border-radius: 18px;
  padding: 18px;
  font-size: 19px;
}
.iconWrap{
  width:86px;
  height:86px;
  border-radius: 18px;
  background: rgba(255,255,255,0.88);
  border:1px solid rgba(0,0,0,0.08);
  box-shadow: 0 14px 30px rgba(0,0,0,0.18);
  overflow:hidden;
  display:grid;
  place-items:center;
}
#serviceIconImg{ width:76px; height:76px; object-fit:contain; display:none; }
#serviceIconSvg{ display:grid; place-items:center; }

/* Service header colours */
#scenarioCard.service-ambulance .cardHead{ background: linear-gradient(135deg,#e53935,#c62828); }
#scenarioCard.service-police .cardHead{ background: linear-gradient(135deg,#2b6cff,#1a49c9); }
#scenarioCard.service-fire .cardHead{ background: linear-gradient(135deg,#ffb020,#e08700); }

/* Response Pad (iPad fallback for no speech recognition) */
.responsePad{
  margin-top: 12px;
  padding: 14px;
  border-radius: 22px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.22);
  box-shadow: 0 14px 30px rgba(0,0,0,0.25);
}
.responseTitle{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  margin-bottom: 10px;
}
.responseTitle h3{
  margin:0;
  font-size: 14px;
  letter-spacing: .6px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.85);
}
.responseHint{
  font-size: 12px;
  color: rgba(255,255,255,0.75);
}
.resGrid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}
.resBtn{
  border:none;
  border-radius: 18px;
  padding: 16px 14px;
  font-weight: 900;
  font-size: 16px;
  cursor:pointer;
}
.resBtn:active{ transform: scale(.99); }
.resBtn.amb{ background: linear-gradient(180deg,#ff5151,#d62d2d); color:#fff; }
.resBtn.pol{ background: linear-gradient(180deg,#2b6cff,#1747c7); color:#fff; }
.resBtn.fire{ background: linear-gradient(180deg,#ffb020,#d97d00); color:#1a1403; }
.resBtn.yes{ background: linear-gradient(180deg,#2fe27f,#1fbf66); color:#06130c; }
.resBtn.no{ background: linear-gradient(180deg,#ff4a4a,#d62d2d); color:#fff; }
.resBtn.repeat{ background: rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.14); color:#fff; }
.resBtn.skip{ background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); color:#fff; }
#srBadge{
  font-weight:900;
  font-size: 11px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(0,0,0,0.22);
  color: rgba(255,255,255,0.85);
  white-space:nowrap;
}
/* ===========================
   PHONE SHELL (realistic frame)
   =========================== */

.phone{
  position: relative;           /* required */
  padding-top: 26px;            /* space for notch */
}

/* Outer bezel shine + edge */
.phone-shell{
  position:absolute;
  inset:0;
  border-radius: 38px;
  pointer-events:none;
  background:
    linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.02));
  box-shadow:
    inset 0 0 0 2px rgba(255,255,255,0.10),
    inset 0 0 0 10px rgba(0,0,0,0.18);
}

/* Side buttons (volume + power) */
.phone::before,
.phone::after{
  content:"";
  position:absolute;
  top: 110px;
  width: 6px;
  height: 110px;
  border-radius: 8px;
  background: rgba(255,255,255,0.14);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
  opacity: 0.9;
  pointer-events:none;
}
.phone::before{ left: -3px; }   /* volume side */
.phone::after{ right: -3px; height: 70px; top: 140px; } /* power side */

/* Notch / top cutout */
.phone-notch{
  position:absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  width: 170px;
  height: 28px;
  border-radius: 0 0 18px 18px;
  background: rgba(0,0,0,0.55);
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 8px 18px rgba(0,0,0,0.35);
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 12px;
  pointer-events:none;
}

/* Speaker + camera dot */
.phone-notch .speaker{
  width: 74px;
  height: 6px;
  border-radius: 999px;
  background: rgba(255,255,255,0.18);
}
.phone-notch .camera{
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: rgba(140,190,255,0.35);
  box-shadow: 0 0 0 2px rgba(0,0,0,0.35);
}

/* Give the topbar a little breathing room under the notch */
.topbar{
  margin-top: 8px;
  border-top-left-radius: 22px;
  border-top-right-radius: 22px;
}

/* Optional: subtle bottom ‚Äúhome indicator‚Äù */
.screen::after{
  content:"";
  display:block;
  height: 6px;
  width: 120px;
  margin: 12px auto 0;
  border-radius: 999px;
  background: rgba(255,255,255,0.12);
}

</style>
</head>
<body>
<div class="app-wrap">
  <div class="app">

    <div class="header">
      <div>
        <h1>999 Emergency Call Simulator</h1>
        
      </div>
      <div class="pill" id="globalStatus">Ready</div>
    </div>

    <div class="phone">
        <div class="phone-shell"></div>
  <div class="phone-notch"><span class="speaker"></span><span class="camera"></span></div>

      <div class="topbar">
        <div>Phone</div>
        <div id="phoneStatus">idle</div>
      </div>

      <div class="screen">
        <div class="digitsWrap">
          <div class="digits" id="digits"> </div>
          <div class="callRow">
            <div id="callLine">Dial 999 then press CALL</div>
            <div class="timer" id="timer">00:00</div>
          </div>
        </div>

        <div class="pad">
          <div class="key" data-k="1"><div class="n">1</div><div class="l">&nbsp;</div></div>
          <div class="key" data-k="2"><div class="n">2</div><div class="l">ABC</div></div>
          <div class="key" data-k="3"><div class="n">3</div><div class="l">DEF</div></div>
          <div class="key" data-k="4"><div class="n">4</div><div class="l">GHI</div></div>
          <div class="key" data-k="5"><div class="n">5</div><div class="l">JKL</div></div>
          <div class="key" data-k="6"><div class="n">6</div><div class="l">MNO</div></div>
          <div class="key" data-k="7"><div class="n">7</div><div class="l">PQRS</div></div>
          <div class="key" data-k="8"><div class="n">8</div><div class="l">TUV</div></div>
          <div class="key" data-k="9"><div class="n">9</div><div class="l">WXYZ</div></div>
          <div class="key" data-k="clear"><div class="n">C</div><div class="l">Clear</div></div>
          <div class="key" data-k="0"><div class="n">0</div><div class="l">+</div></div>
          <div class="key" data-k="back"><div class="n">‚å´</div><div class="l">Back</div></div>
        </div>

        <div class="row">
          <button class="btn callBtn" id="callBtn" disabled>CALL</button>
          <button class="btn endBtn" id="endBtn" disabled>END</button>
        </div>

        <div class="wave"></div>
      </div>
    </div>

    <div class="card" id="scenarioCard">
      <div class="cardHead">
        <div>Scenario</div>
        <div class="badge" id="serviceBadge">‚Äî</div>
      </div>

      <div class="cardBody">
        <div class="ribbonRow">
          <div class="ribbon" id="scenarioRibbon">TRAINING SCENARIO</div>
          <div class="idPill" id="scenarioIdPill">‚Äî</div>
        </div>
        <div class="hero">
          <div class="iconWrap" id="serviceIconWrap">
  <img id="serviceIconImg" alt="" />
  <div id="serviceIconSvg" aria-hidden="true"></div>
</div>
          <div>
            <h2 id="scenarioTitle">Loading‚Ä¶</h2>
            <div class="small" id="scenarioMeta">‚Äî</div>
          </div>
        </div>

        <div class="desc" id="scenarioDesc"></div>

        <div class="cardActions">
          <button class="action read" id="readScenarioBtn">üîä Read Scenario</button>
          <button class="action next" id="nextScenarioBtn">Next Scenario</button>
        </div>

        <div class="note">Tip: Press ‚ÄúRead Scenario‚Äù if reading is difficult. Then dial 999 and follow the call.</div>
      </div>
    </div>
   </div> <!-- end .app -->
</div> <!-- end .app-wrap -->



<script>
(function(){
  var SCENARIOS = [{"id": "A1", "service": "ambulance", "title": "Collapse - Not Breathing", "desc": "Someone has collapsed. They are not breathing."}, {"id": "A2", "service": "ambulance", "title": "Collapse - Unconscious", "desc": "Someone has collapsed. They are breathing but not waking up."}, {"id": "A3", "service": "ambulance", "title": "Severe Bleeding", "desc": "Someone has a deep cut and is bleeding a lot."}, {"id": "A4", "service": "ambulance", "title": "Choking", "desc": "Someone is choking and cannot breathe properly."}, {"id": "A5", "service": "ambulance", "title": "Seizure", "desc": "Someone has fallen to the floor and is shaking."}, {"id": "A6", "service": "ambulance", "title": "Allergic Reaction", "desc": "Someone is having a bad allergic reaction. Their face is swelling and they are struggling to breathe."}, {"id": "A7", "service": "ambulance", "title": "Chest Pain", "desc": "Someone has sudden chest pain and feels very unwell."}, {"id": "A8", "service": "ambulance", "title": "Serious Fall", "desc": "Someone has fallen badly and hit their head."}, {"id": "A9", "service": "ambulance", "title": "Burn or Scald", "desc": "Someone has been badly burned by something hot."}, {"id": "A10", "service": "ambulance", "title": "Breathing Difficulty", "desc": "Someone is struggling to breathe and getting worse."}, {"id": "P1", "service": "police", "title": "Followed (City Centre)", "desc": "You are in the city centre. Someone has been following you and you feel unsafe."}, {"id": "P2", "service": "police", "title": "Street Disturbance", "desc": "There is shouting and fighting on your street."}, {"id": "P3", "service": "police", "title": "Concerning Sounds", "desc": "You can hear screaming or loud banging from a house on your street."}, {"id": "P4", "service": "police", "title": "Crime in Progress", "desc": "You can see someone damaging property or breaking into a place. It is happening now."}, {"id": "P5", "service": "police", "title": "Threatening Behaviour", "desc": "Someone is being aggressive or threatening people."}, {"id": "P6", "service": "police", "title": "Weapon Seen", "desc": "You can see someone with a weapon and you feel scared."}, {"id": "F1", "service": "fire", "title": "Fire at Home", "desc": "There is a fire in your home."}, {"id": "F2", "service": "fire", "title": "Fire at College", "desc": "There is a fire at your college (Powerhouse)."}, {"id": "F3", "service": "fire", "title": "Smoke from Building", "desc": "You can see smoke coming from a building."}, {"id": "F4", "service": "fire", "title": "Alarm + Smoke", "desc": "A fire alarm is going off and there is smoke."}, {"id": "F5", "service": "fire", "title": "Possible Person Trapped", "desc": "There is a fire and someone might be trapped inside."}, {"id": "F6", "service": "fire", "title": "Car Fire", "desc": "A car is on fire."}];
  var byService = { ambulance:"AMBULANCE", police:"POLICE", fire:"FIRE" };

  function iconSVG(service){
    if (service === "ambulance") return '<svg width="44" height="44" viewBox="0 0 64 64" fill="none" aria-hidden="true"><circle cx="32" cy="32" r="30" fill="#ff4b4b" opacity="0.22"/><path d="M18 40h4l3-12h14l3 12h4" stroke="#e8eefc" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 28h20l6 6v6H22v-12Z" fill="#e8eefc" opacity="0.10"/><path d="M22 28h20l6 6v6H22v-12Z" stroke="#e8eefc" stroke-width="3" stroke-linejoin="round"/><path d="M31 23v10M26 28h10" stroke="#e8eefc" stroke-width="3" stroke-linecap="round"/><circle cx="26" cy="44" r="4" fill="#e8eefc"/><circle cx="44" cy="44" r="4" fill="#e8eefc"/></svg>';
    if (service === "police") return '<svg width="44" height="44" viewBox="0 0 64 64" fill="none" aria-hidden="true"><circle cx="32" cy="32" r="30" fill="#2b6cff" opacity="0.22"/><path d="M32 12l8 6v12c0 10-6 18-8 20-2-2-8-10-8-20V18l8-6Z" stroke="#e8eefc" stroke-width="3" fill="#e8eefc" opacity="0.10"/><path d="M32 18l2 6h6l-5 4 2 6-5-4-5 4 2-6-5-4h6l2-6Z" fill="#e8eefc"/></svg>';
    return '<svg width="44" height="44" viewBox="0 0 64 64" fill="none" aria-hidden="true"><circle cx="32" cy="32" r="30" fill="#ffb020" opacity="0.22"/><path d="M34 14c2 6-3 9-3 13 0 3 2 5 5 6-2 3-6 4-9 2 0 8 7 15 15 15 8 0 14-6 14-14 0-12-15-14-22-22Z" fill="#ffd37d" opacity="0.30"/><path d="M30 20c1 4-2 6-2 9 0 4 4 6 8 6-1 5-6 8-11 7 1 6 7 10 14 10 7 0 12-5 12-12 0-10-12-12-21-20Z" stroke="#e8eefc" stroke-width="2.5" stroke-linejoin="round"/></svg>';
  }

  var globalStatus = document.getElementById("globalStatus");
  var digitsEl = document.getElementById("digits");
  var phoneStatus = document.getElementById("phoneStatus");
  var callLine = document.getElementById("callLine");
  var timerEl = document.getElementById("timer");
  var callBtn = document.getElementById("callBtn");
  var endBtn = document.getElementById("endBtn");

  var serviceBadge = document.getElementById("serviceBadge");
  var scenarioCard = document.getElementById("scenarioCard");
  var serviceIconImg = document.getElementById("serviceIconImg");
  var serviceIconSvg = document.getElementById("serviceIconSvg");
  var scenarioIdPill = document.getElementById("scenarioIdPill");
  var scenarioTitle = document.getElementById("scenarioTitle");
  var scenarioMeta = document.getElementById("scenarioMeta");
  var scenarioDesc = document.getElementById("scenarioDesc");
  var readScenarioBtn = document.getElementById("readScenarioBtn");
  var nextScenarioBtn = document.getElementById("nextScenarioBtn");

  function setGlobal(t){ globalStatus.textContent = t; }
  function setPhoneStatusText(t){ phoneStatus.textContent = t; }

  // Scenario
  var currentScenario = null;
  var scenarioIndex = -1;

  function pickNextScenario(){
    var next = null;
    for (var tries=0; tries<8; tries++){
      var idx = Math.floor(Math.random() * SCENARIOS.length);
      if (!currentScenario || SCENARIOS[idx].id !== currentScenario.id){
        next = SCENARIOS[idx];
        scenarioIndex = idx;
        break;
      }
    }
    if (!next){
      scenarioIndex = (scenarioIndex + 1) % SCENARIOS.length;
      next = SCENARIOS[scenarioIndex];
    }
    currentScenario = next;
    renderScenario();
  }

  function renderScenario(){
    var s = currentScenario;
    if (!s) return;
    serviceBadge.textContent = byService[s.service] || String(s.service).toUpperCase();
    scenarioCard.className = "card service-" + s.service;
scenarioIdPill.textContent = "ID: " + s.id;

// Icon placeholders in same folder as HTML:
// ambulance.png, police.png, fire.png
var src = s.service + ".png";
serviceIconImg.style.display = "none";
serviceIconSvg.style.display = "grid";
serviceIconSvg.innerHTML = iconSVG(s.service);

serviceIconImg.onload = function(){
  serviceIconImg.style.display = "block";
  serviceIconSvg.style.display = "none";
};
serviceIconImg.onerror = function(){
  serviceIconImg.style.display = "none";
  serviceIconSvg.style.display = "grid";
};
serviceIconImg.src = src;

    scenarioTitle.textContent = s.title;
    scenarioMeta.textContent = "Scenario " + s.id + " ‚Ä¢ " + (byService[s.service] || "");
    scenarioDesc.textContent = s.desc;
  }

  // Dial pad
  var dial = "";
  function renderDial(){
    digitsEl.textContent = dial || " ";
    callBtn.disabled = !(dial === "999") || state !== STATE.IDLE;
  }

  function onKeyClick(e){
    if (state !== STATE.IDLE) return;
    var key = e.currentTarget.getAttribute("data-k");
    if (key === "clear") dial = "";
    else if (key === "back") dial = dial.slice(0,-1);
    else if (dial.length < 3) dial += key;
    renderDial();
  }

  var keys = document.querySelectorAll(".key");
  for (var i=0; i<keys.length; i++) keys[i].addEventListener("click", onKeyClick);

  // Timer
  var callStartMs = null;
  var timerInterval = null;
  function fmtTime(ms){
    var total = Math.max(0, Math.floor(ms/1000));
    var m = Math.floor(total/60);
    var s = total % 60;
    var mm = (m<10 ? "0"+m : ""+m);
    var ss = (s<10 ? "0"+s : ""+s);
    return mm + ":" + ss;
  }
  function startTimer(){
    callStartMs = new Date().getTime();
    timerEl.textContent = "00:00";
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(function(){
      timerEl.textContent = fmtTime(new Date().getTime() - callStartMs);
    }, 250);
  }
  function stopTimer(){
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    callStartMs = null;
    timerEl.textContent = "00:00";
  }

  // TTS
  var chosenVoice = null;
  var ttsReady = false;

  function pickBestVoice(){
    if (!window.speechSynthesis || !window.speechSynthesis.getVoices) return null;
    var voices = window.speechSynthesis.getVoices();
    if (!voices || !voices.length) return null;

    var gb = [], en = [];
    for (var v=0; v<voices.length; v++){
      var lang = (voices[v].lang || "").toLowerCase();
      if (lang.indexOf("en-gb") === 0) gb.push(voices[v]);
      else if (lang.indexOf("en") === 0) en.push(voices[v]);
    }

    function prefer(list){
      if (!list.length) return null;
      for (var j=0; j<list.length; j++){
        if (/(female|susan|serena|kate|amy|hazel|siri)/i.test(list[j].name)) return list[j];
      }
      for (var k=0; k<list.length; k++){
        if (!/(robot|compact)/i.test(list[k].name)) return list[k];
      }
      return list[0];
    }

    return prefer(gb) || prefer(en) || voices[0];
  }

  if (window.speechSynthesis){
    chosenVoice = pickBestVoice();
    window.speechSynthesis.onvoiceschanged = function(){
      if (!chosenVoice) chosenVoice = pickBestVoice();
    };
  }

  function speak(text){
    if (!ttsReady) return;
    if (!window.speechSynthesis) return;
    var clean = String(text || "").replace(/\s+/g," ").trim();
    if (!clean) return;

    // Prevent the mic from "hearing" the operator voice (feedback loop)
    try { stopListening(); } catch(e){}

    var u = new SpeechSynthesisUtterance(clean);
    u.lang = (chosenVoice && chosenVoice.lang) ? chosenVoice.lang : "en-GB";
    if (chosenVoice) u.voice = chosenVoice;
    u.rate = 0.95; u.pitch = 1.0; u.volume = 1.0;

    u.onend = function(){
      setTimeout(function(){
        try { startListening(); } catch(e){}
      }, 350);
    };

    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }


  readScenarioBtn.addEventListener("click", function(){
    if (!currentScenario) return;
    ttsReady = true;
    if (!chosenVoice) chosenVoice = pickBestVoice();
    var s = currentScenario;
    speak("Emergency scenario. " + byService[s.service] + ". " + s.desc + " Dial nine nine nine and call " + String(byService[s.service]).toLowerCase() + ".");
  });

  nextScenarioBtn.addEventListener("click", function(){
    if (state !== STATE.IDLE){
      ttsReady = true;
      speak("Please end the call before moving to the next scenario.");
      return;
    }
   
  pickNextScenario();
  });

  // Speech Recognition
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  var isiPadLike = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  var responsePad = document.getElementById("responsePad");
  var srBadge = document.getElementById("srBadge");
  var lastPromptText = "";
  function setLastPrompt(t){ lastPromptText = t || ""; }
  function updateMicBadge(has){
    if (!srBadge) return;
    srBadge.textContent = has ? "Mic: available" : "Mic: unavailable";
  }
  function showResponsePad(show){
    if (!responsePad) return;
    responsePad.style.display = show ? "block" : "none";
  }

  var hasSR = !!SpeechRecognition;
  var rec = null;
  var shouldListen = false;

  function startListening(){
    if (!hasSR){
      speak("Speech recognition is not available on this device. Please use Chrome or Microsoft Edge.");
      return;
    }
    shouldListen = true;
    listenNow();
  }
  function stopListening(){
    shouldListen = false;
    if (rec){
      try{
        rec.onstart = null; rec.onerror = null; rec.onend = null; rec.onresult = null;
        rec.stop();
      }catch(e){}
    }
    rec = null;
  }
  function cleanupRec(){
    if (!rec) return;
    try{
      rec.onstart = null; rec.onerror = null; rec.onend = null; rec.onresult = null;
    }catch(e){}
    rec = null;
  }
  function listenNow(){
    if (!shouldListen) return;
    if (state === STATE.IDLE || state === STATE.RINGING || state === STATE.DONE) return;
    if (rec) return;

    rec = new SpeechRecognition();
    rec.lang = "en-GB";
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    try { rec.continuous = true; } catch(e) {}

    rec.onstart = function(){ setPhoneStatusText("connected ‚Ä¢ listening"); };
    rec.onerror = function(){ cleanupRec(); setTimeout(listenNow, 600); };
    rec.onend = function(){ cleanupRec(); if (shouldListen && state !== STATE.DONE && state !== STATE.IDLE) setTimeout(listenNow, 250); };
    rec.onresult = function(event){
      var start = (typeof event.resultIndex === "number") ? event.resultIndex : (event.results.length - 1);
      for (var r=start; r<event.results.length; r++){
        var res = event.results[r];
        if (!res || !res[0]) continue;
        var t = String(res[0].transcript || "").replace(/^\s+|\s+$/g,"");
        if (t) onUtterance(t);
      }
    };

    try { rec.start(); } catch(e){ cleanupRec(); setTimeout(listenNow, 800); }
  }

  // Call flow
  var STATE = {
    IDLE:"idle", RINGING:"ringing", BT_SERVICE:"bt_service",
    AMB_WHAT:"amb_what", AMB_AWAKE:"amb_awake", AMB_BREATHING:"amb_breathing", AMB_LOCATION:"amb_location", AMB_CALLBACK:"amb_callback",
    POL_WHAT:"pol_what", POL_DANGER:"pol_danger", POL_LOCATION:"pol_location", POL_CALLBACK:"pol_callback",
    FIRE_WHAT:"fire_what", FIRE_LOCATION:"fire_location", FIRE_ANYONE:"fire_anyone", FIRE_SMOKE:"fire_smoke", FIRE_CALLBACK:"fire_callback",
    DONE:"done"
  };
  var state = STATE.IDLE;

  // Don't accept speech answers until this timestamp (ms)
  var canAcceptUntil = 0;

var reServiceAmb = /\b(ambulance|ambulan[cs]e|ambalance|medical|medic|paramedic)\b/i;
var reServicePol = /\b(police|po[ -]?lice|poli[sc]e|cops|officer)\b/i;
var reServiceFire = /\b(fire|fyre|fire\s*service|fire\s*brigade|firefighters)\b/i;


  var reYes = /\b(yes|yeah|yep|yup|ya|correct|that's right|right|affirmative|sure|okay|ok)\b/i;
  var reNo  = /\b(no|nope|nah|negative|not)\b/i;

  function ask(line){
    // Block recognition briefly so we don't immediately capture the operator audio
    // or short noises and skip ahead.
    canAcceptUntil = new Date().getTime() + 1200;
    speak(line);
  }

  function beginCall(){
    if (dial !== "999") return;
    if (!currentScenario) pickNextScenario();

    ttsReady = true;
    if (!chosenVoice) chosenVoice = pickBestVoice();

    state = STATE.RINGING;
    setGlobal("Calling‚Ä¶");
    setPhoneStatusText("calling‚Ä¶");
    callLine.textContent = "CALLING 999‚Ä¶";
    callBtn.disabled = true;
    endBtn.disabled = false;
    startTimer();
    speak("Calling nine nine nine.");

    setTimeout(function(){
      state = STATE.BT_SERVICE;
      setGlobal("Connected");
      setPhoneStatusText("connected");
      callLine.textContent = "CALL CONNECTED";
      startListening();
      ask("Emergency. Which service do you require? Fire, Police or Ambulance?");
    }, 900);
  }

  function endCall(){
    stopListening();
    stopTimer();
    showResponsePad(false);
    state = STATE.IDLE;
    setGlobal("Ready");
    setPhoneStatusText("idle");
    callLine.textContent = "Dial 999 then press CALL";
    endBtn.disabled = true;
    dial = "";
    renderDial();
    speak("Call ended. Press next scenario when you are ready.");
  }

  callBtn.addEventListener("click", beginCall);
  endBtn.addEventListener("click", function(){ if (state !== STATE.IDLE) endCall(); });

  function onUtterance(text){
    if (!currentScenario) return;

    // Wait a moment after each operator line so the student has time to respond
    // and so we don't capture the operator voice.
    if (new Date().getTime() < canAcceptUntil) return;

    var need = currentScenario.service;

    if (state === STATE.BT_SERVICE){
      var ok = false;
      if (need === "ambulance" && reServiceAmb.test(text)) ok = true;
      if (need === "police" && reServicePol.test(text)) ok = true;
      if (need === "fire" && reServiceFire.test(text)) ok = true;

      if (ok){
        if (need === "ambulance"){ state = STATE.AMB_WHAT; ask("Ambulance service. Tell me exactly what happened."); }
        else if (need === "police"){ state = STATE.POL_WHAT; ask("Police. Tell me exactly what's happening."); }
        else { state = STATE.FIRE_WHAT; ask("Fire service. Tell me where the fire is."); }
     } else {
  // If speech recognition is unreliable, repeat more clearly
  ask("Please say one word: Fire, Police, or Ambulance.");
}

      return;
    }

    if (state === STATE.AMB_AWAKE){
      if (reYes.test(text) || reNo.test(text)){
        state = STATE.AMB_BREATHING; ask("Is the patient breathing?");
      } else ask("Is the patient awake? Please say yes or no.");
      return;
    }

    if (state === STATE.AMB_BREATHING){
      if (reYes.test(text) || reNo.test(text)){
        state = STATE.AMB_LOCATION;
        ask("What is the address or location of the emergency? You can say a postcode or a nearby landmark.");
      } else ask("Is the patient breathing? Please say yes or no.");
      return;
    }

    if (state === STATE.POL_DANGER){
      if (reYes.test(text) || reNo.test(text)){
        state = STATE.POL_LOCATION; ask("Where are you right now? Tell me the location.");
      } else ask("Are you in immediate danger right now? Please say yes or no.");
      return;
    }

    if (state === STATE.FIRE_ANYONE){
      if (reYes.test(text) || reNo.test(text)){
        state = STATE.FIRE_SMOKE; ask("Is there smoke or flames? Please say smoke, flames, or both.");
      } else ask("Is anyone inside the building? Please say yes or no.");
      return;
    }

    if (state === STATE.FIRE_SMOKE){
      state = STATE.FIRE_CALLBACK; ask("What number are you calling from?"); return;
    }

    if (state === STATE.AMB_WHAT){ state = STATE.AMB_AWAKE; ask("Is the patient awake?"); return; }
    if (state === STATE.AMB_LOCATION){ state = STATE.AMB_CALLBACK; ask("Thank you. What number are you calling from?"); return; }
    if (state === STATE.AMB_CALLBACK){ state = STATE.DONE; setGlobal("Scenario complete"); ask("Thank you. Help is being sent. Stay on the line."); return; }

    if (state === STATE.POL_WHAT){ state = STATE.POL_DANGER; ask("Are you in immediate danger right now?"); return; }
    if (state === STATE.POL_LOCATION){ state = STATE.POL_CALLBACK; ask("Thank you. What number are you calling from?"); return; }
    if (state === STATE.POL_CALLBACK){ state = STATE.DONE; setGlobal("Scenario complete"); ask("Thank you. Officers are being sent. Stay on the line."); return; }

    if (state === STATE.FIRE_WHAT){ state = STATE.FIRE_LOCATION; ask("Tell me the address or location of the fire."); return; }
    if (state === STATE.FIRE_LOCATION){ state = STATE.FIRE_ANYONE; ask("Is anyone inside the building?"); return; }
    if (state === STATE.FIRE_CALLBACK){ state = STATE.DONE; setGlobal("Scenario complete"); ask("Thank you. Fire service is on the way. Leave the building if it is safe to do so."); return; }
  }

  // Init
  pickNextScenario();
  renderDial();
  setGlobal("Ready");
  setPhoneStatusText("idle");
  callLine.textContent = "Dial 999 then press CALL";
})();
</script>
<script>
(function(){
  function fitApp(){
    var app = document.querySelector(".app-wrap");

    if(!app) return;

    // Temporarily remove scaling to measure the natural size
    app.style.transform = "none";

    // Available space
    var vw = window.innerWidth;
    var vh = window.innerHeight;

    // Give a little breathing room (matches your body padding)
    var pad = 18;
    var availW = vw - (pad * 2);
    var availH = vh - (pad * 2);

    // Measure natural size
    var rect = app.getBoundingClientRect();
    var w = rect.width;
    var h = rect.height;

    // Calculate scale to fit both width + height
    var scale = Math.min(availW / w, availH / h);

    // Clamp so it doesn‚Äôt become tiny on very small screens
    scale = Math.max(0.72, Math.min(1, scale));

    // Apply scale via CSS variable
    document.documentElement.style.setProperty("--fitScale", scale);

    // Restore scaling
    app.style.transform = "scale(var(--fitScale))";
  }

  window.addEventListener("load", fitApp);
  window.addEventListener("resize", fitApp);
  window.addEventListener("orientationchange", fitApp);
})();
</script>

</body>
</html>
